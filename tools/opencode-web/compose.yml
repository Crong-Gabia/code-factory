# OpenCode Web UI (macOS local)
# - localhost only: http://localhost:4096
# - Required env: OPENAI_API_KEY, GEMINI_API_KEY
# - Optional env: PROJECT_DIR (host path mounted into container as /workspace)

services:
  opencode-web:
    build:
      context: .
      dockerfile: Dockerfile
    working_dir: /workspace
    ports:
      - "127.0.0.1:4096:4096"
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
    volumes:
      # Persist OpenCode config/sessions across restarts
      - opencode_config:/root/.config/opencode

      # Project workspace
      # If PROJECT_DIR is not set, an empty local directory is mounted.
      - ${PROJECT_DIR:-./empty-workspace}:/workspace

      # Optional user override config (do not commit secrets)
      - ./user-config:/user-config
    command: >
      bash -lc "
        mkdir -p /root/.config/opencode &&
        oh-my-opencode install --no-tui --skip-auth --openai=yes --gemini=yes --claude=no --copilot=no --opencode-zen=yes --zai-coding-plan=no &&
        if [ -f /user-config/oh-my-opencode.json ]; then
          echo 'Using user override: tools/opencode-web/user-config/oh-my-opencode.json' &&
          cp -f /user-config/oh-my-opencode.json /root/.config/opencode/oh-my-opencode.json;
        elif [ -f /workspace/config/opencode/oh-my-opencode.json ]; then
          echo 'Using repo config: config/opencode/oh-my-opencode.json' &&
          cp -f /workspace/config/opencode/oh-my-opencode.json /root/.config/opencode/oh-my-opencode.json;
        fi &&
        opencode web --hostname 0.0.0.0 --port 4096
      "

volumes:
  opencode_config:
